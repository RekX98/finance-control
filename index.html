<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å</title>

<style>
:root{
  --blue:#1f5bff;
  --bg:#f4f6fb;
  --card:#fff;
  --text:#0f172a;
  --muted:#64748b;
  --danger:#dc2626;
  --ok:#16a34a;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{background:var(--blue);color:#fff;padding:24px;text-align:center}
main{max-width:960px;margin:auto;padding:16px}
.box{background:var(--card);border-radius:16px;padding:18px;margin:14px 0}
label{display:block;margin-top:10px;font-weight:800}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:720px){.row{grid-template-columns:1fr}}
button{padding:12px 16px;border:none;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
button.light{background:#eaf2ff;color:#000}
button.danger{background:var(--danger)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.result{display:none;background:#eaf2ff;border-left:6px solid var(--blue);padding:14px;border-radius:14px;margin-top:14px}
.hint{font-size:13px;color:var(--muted)}
canvas{width:100%;height:220px;background:#fff;border-radius:12px}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:14px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:center}
.saved{display:none;background:#fff;padding:14px;border-radius:14px;margin-top:14px}
.savedItem{border:1px solid #ddd;padding:10px;border-radius:10px;margin-bottom:8px}
</style>
</head>

<body>

<header>
<h1>–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å</h1>
<p>–ö—Ä–µ–¥–∏—Ç–Ω–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</p>
</header>

<main>

<div class="box">
<label>–°—É–º–∞</label>
<input id="sum" type="number">

<div class="row">
<div>
<label>%</label>
<input id="percent" type="number">
</div>
<div>
<label>–ü–µ—Ä—ñ–æ–¥</label>
<select id="rateType">
<option value="month">% / –º—ñ—Å—è—Ü—å</option>
<option value="year">% / —Ä—ñ–∫</option>
</select>
</div>
</div>

<div class="row">
<div>
<label>–ú—ñ—Å—è—Ü—ñ–≤</label>
<input id="months" type="number">
</div>
<div>
<label>–¢–∏–ø</label>
<select id="loanType">
<option value="annuity">–ê–Ω–Ω—É—ó—Ç–µ—Ç</option>
<option value="diff">–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–æ–≤–∞–Ω–∏–π</option>
</select>
</div>
</div>

<div class="actions">
<button onclick="calculate()">–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
<button class="light" onclick="toggleSaved()">–Ü—Å—Ç–æ—Ä—ñ—è</button>
</div>

<div id="result" class="result">
<div id="warning" class="hint"></div>

<p><b>–í—Å—å–æ–≥–æ:</b> <span id="total"></span></p>
<p><b>–ü–µ—Ä–µ–ø–ª–∞—Ç–∞:</b> <span id="overpay"></span></p>
<p><b>–ú—ñ—Å—è—á–Ω–∏–π:</b> <span id="monthly"></span></p>

<canvas id="chart"></canvas>

<table>
<thead>
<tr><th>–ú—ñ—Å</th><th>%</th><th>–ü–ª–∞—Ç—ñ–∂</th><th>–ó–∞–ª–∏—à–æ–∫</th></tr>
</thead>
<tbody id="table"></tbody>
</table>

<div class="actions">
<button onclick="saveCalc()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
<button class="light" onclick="exportPDF()">üìÑ PDF</button>
<button class="light" onclick="exportExcel()">üìä Excel</button>
</div>
</div>

<div id="saved" class="saved">
<button class="danger" onclick="clearSaved()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
<div id="savedList"></div>
</div>

</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const fmt = n => n.toFixed(2)

function getRate(){
  let p=+percent.value
  return rateType.value==='year'?p/100/12:p/100
}

function calculate(){
  let s=+sum.value,m=+months.value,r=getRate()
  if(!s||!m)return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è')

  let ann=[],diff=[],bal=s
  table.innerHTML=''
  let total=0

  let mp=r? s*r/(1-Math.pow(1+r,-m)) : s/m

  for(let i=1;i<=m;i++){
    let int=bal*r
    let pr=mp-int
    bal-=pr;if(bal<0)bal=0
    ann.push(bal)
    table.innerHTML+=`<tr><td>${i}</td><td>${fmt(int)}</td><td>${fmt(mp)}</td><td>${fmt(bal)}</td></tr>`
    total+=mp
  }

  bal=s
  let part=s/m
  for(let i=1;i<=m;i++){
    bal-=part;if(bal<0)bal=0
    diff.push(bal)
  }

  drawChart(ann,diff)

  totalSpan(total,mp,s,r)
}

function totalSpan(total,mp,s,r){
  totalSpan=total
  totalEl.innerText=fmt(total)
  overpay.innerText=fmt(total-s)
  monthly.innerText=fmt(mp)

  warning.innerText =
    r>=0.3?'‚ö†Ô∏è –ö–∞–±–∞–ª—å–Ω–∏–π %':
    r>=0.05?'‚ùó –í–∏—Å–æ–∫–∏–π %':'‚úÖ –ù–æ—Ä–º–∞'

  result.style.display='block'
  window.last={s,total,mp}
}

function drawChart(a,b){
  let c=chart,ctx=c.getContext('2d')
  c.width=c.offsetWidth;ctx.clearRect(0,0,c.width,c.height)
  let max=Math.max(...a,...b),step=c.width/(a.length-1)
  const line=(d,col)=>{
    ctx.beginPath()
    d.forEach((v,i)=>{
      let x=i*step,y=c.height-(v/max*c.height)
      i?ctx.lineTo(x,y):ctx.moveTo(x,y)
    })
    ctx.strokeStyle=col;ctx.lineWidth=3;ctx.stroke()
  }
  line(a,'#1f5bff');line(b,'#16a34a')
}

function saveCalc(){
  let arr=JSON.parse(localStorage.getItem('calc')||'[]')
  arr.push(window.last)
  localStorage.setItem('calc',JSON.stringify(arr))
  renderSaved()
}

function renderSaved(){
  let arr=JSON.parse(localStorage.getItem('calc')||'[]')
  savedList.innerHTML=arr.map(x=>`<div class="savedItem">–°—É–º–∞ ${x.s}</div>`).join('')
}

function clearSaved(){
  localStorage.removeItem('calc')
  renderSaved()
}

function toggleSaved(){
  saved.style.display=saved.style.display?'':'block'
  renderSaved()
}

function exportPDF(){html2pdf().from(result).save()}
function exportExcel(){XLSX.writeFile(XLSX.utils.book_new(),'calc.xlsx')}
</script>

</body>
</html>
