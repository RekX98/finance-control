<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å</title>
  <style>
    :root{
      --blue:#1f5bff;
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --danger:#dc2626;
      --ok:#16a34a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:var(--blue);
      color:#fff;
      padding:24px 16px;
      text-align:center;
    }
    header h1{margin:0;font-size:28px;font-weight:800}
    header p{margin:8px 0 0;opacity:.9}

    main{max-width:950px;margin:0 auto;padding:16px}
    .box{
      background:var(--card);
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
      margin:14px 0;
    }
    .box h2{margin:0 0 10px;font-size:26px}
    .box p{margin:0;color:var(--muted);line-height:1.4}

    label{display:block;margin:10px 0 6px;font-weight:800}
    input,select{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus,select:focus{
      border-color:rgba(31,91,255,.6);
      box-shadow:0 0 0 4px rgba(31,91,255,.12)
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){
      .row{grid-template-columns:1fr}
    }

    button{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:14px;
      padding:12px 16px;
      background:var(--blue);
      color:#fff;
      border:none;
      border-radius:12px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }
    button.secondary{
      background:#0f172a;
    }
    button.light{
      background:#eaf2ff;
      color:#0f172a;
      border:1px solid rgba(15,23,42,.10);
    }
    button.danger{
      background:var(--danger);
    }
    button:active{transform:translateY(1px)}

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    .hint{
      font-size:13px;
      color:var(--muted);
      margin-top:6px;
    }

    .result-box{
      display:none;
      margin-top:14px;
      background:#eaf2ff;
      border-left:6px solid var(--blue);
      border-radius:14px;
      padding:14px;
    }
    .result-line{
      font-size:18px;
      margin:10px 0;
      font-weight:900;
    }
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      margin-left:8px;
      vertical-align:middle;
      background:#fff;
      border:1px solid rgba(15,23,42,.1);
      color:#0f172a;
    }
    .badge.danger{border-color:rgba(220,38,38,.35); color:var(--danger)}
    .badge.ok{border-color:rgba(22,163,74,.35); color:var(--ok)}

    .chartWrap{
      margin-top:10px;
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:12px;
      padding:10px;
    }
    #chart{
      width:100%;
      max-width:100%;
      display:block;
      height:220px;
    }

    .tableWrap{
      margin-top:14px;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:560px;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:center;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    th{
      background:#f1f5ff;
      font-weight:900;
    }
    tr:last-child td{border-bottom:none}

    .savedBox{
      display:none;
      margin-top:14px;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:14px;
    }
    .savedHeader{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .savedHeader h3{margin:0}
    .savedList{
      display:grid;
      gap:10px;
    }
    .savedItem{
      border:1px solid rgba(15,23,42,.10);
      border-radius:12px;
      padding:12px;
      background:#fafbff;
    }
    .savedItem .top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .savedItem .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .savedItem .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* Print */
    @media print {
      header, .actions, .savedBox, .hint { display:none !important; }
      body { background:#fff; }
      .box { box-shadow:none; border:1px solid #ddd; }
      .result-box { display:block !important; }
      .tableWrap { overflow:visible; }
      table { min-width:auto; }
    }
  </style>
</head>

<body>
  <header>
    <h1>–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å</h1>
    <p>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫—Ä–µ–¥–∏—Ç—É + –≥—Ä–∞—Ñ—ñ–∫ + –µ–∫—Å–ø–æ—Ä—Ç + –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</p>
  </header>

  <main>
    <div class="box">
      <h2>–î–ª—è —á–æ–≥–æ —Ü–µ–π —Å–∞–π—Ç</h2>
      <p>–ö–æ–Ω—Ç—Ä–æ–ª—å –±–æ—Ä–≥—ñ–≤, –ø–ª–∞—Ç–µ–∂—ñ–≤ —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö —Ä—ñ—à–µ–Ω—å. –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–∏—à–µ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
    </div>

    <div class="box">
      <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–æ—Ä–≥—É</h2>

      <label>–°—É–º–∞ –±–æ—Ä–≥—É (–≥—Ä–Ω)</label>
      <input type="number" id="sum" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 10000" inputmode="numeric" />

      <div class="row">
        <div>
          <label>–í—ñ–¥—Å–æ—Ç–æ–∫</label>
          <input type="number" id="percent" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 5" inputmode="decimal" />
          <div class="hint">–í–≤–æ–¥—å —è–∫ —É –¥–æ–≥–æ–≤–æ—Ä—ñ: 5 –∞–±–æ 55.</div>
        </div>
        <div>
          <label>–ü–µ—Ä—ñ–æ–¥ –≤—ñ–¥—Å–æ—Ç–∫–∞</label>
          <select id="rateType">
            <option value="month">% –Ω–∞ –º—ñ—Å—è—Ü—å</option>
            <option value="year">% –Ω–∞ —Ä—ñ–∫</option>
          </select>
          <div class="hint">–Ø–∫—â–æ % –Ω–∞ —Ä—ñ–∫ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–¥—ñ–ª–∏–º–æ –Ω–∞ 12.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>–¢–µ—Ä–º—ñ–Ω (–º—ñ—Å—è—Ü—ñ–≤)</label>
          <input type="number" id="months" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 12" inputmode="numeric" />
        </div>
        <div>
          <label>–¢–∏–ø –∫—Ä–µ–¥–∏—Ç—É</label>
          <select id="loanType">
            <option value="annuity">–ê–Ω–Ω—É—ó—Ç–µ—Ç–Ω–∏–π (—Ä—ñ–≤–Ω–∏–π –ø–ª–∞—Ç—ñ–∂)</option>
            <option value="diff">–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–æ–≤–∞–Ω–∏–π (–ø–ª–∞—Ç—ñ–∂ –∑–º–µ–Ω—à—É—î—Ç—å—Å—è)</option>
          </select>
          <div class="hint">–ê–Ω–Ω—É—ó—Ç–µ—Ç: –ø–ª–∞—Ç—ñ–∂ —Ä—ñ–≤–Ω–∏–π. –î–∏—Ñ–µ—Ä–µ–Ω—Ü.: –ø–µ—Ä—à—ñ –ø–ª–∞—Ç–µ–∂—ñ –±—ñ–ª—å—à—ñ.</div>
        </div>
      </div>

      <div class="actions">
        <button type="button" onclick="calculate()">üßÆ –ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <button type="button" class="light" onclick="fillDemo()">‚ú® –î–µ–º–æ</button>
        <button type="button" class="secondary" onclick="toggleSaved()">üìÇ –Ü—Å—Ç–æ—Ä—ñ—è</button>
      </div>

      <div id="result" class="result-box">
        <div class="result-line">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: <span id="total">0.00</span> –≥—Ä–Ω <span id="badgeTotal" class="badge"></span></div>
        <div class="result-line">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞: <span id="overpay">0.00</span> –≥—Ä–Ω <span id="badgeOver" class="badge"></span></div>
        <div class="result-line">–©–æ–º—ñ—Å—è—á–Ω–∏–π –ø–ª–∞—Ç—ñ–∂: <span id="monthly">0.00</span> –≥—Ä–Ω <span class="badge">–∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</span></div>

        <h3 style="margin:18px 0 10px;">–ì—Ä–∞—Ñ—ñ–∫ –∑–∞–ª–∏—à–∫—É –±–æ—Ä–≥—É</h3>
        <div class="chartWrap">
          <canvas id="chart" height="220"></canvas>
        </div>

        <h3 style="margin:18px 0 10px;">–ì—Ä–∞—Ñ—ñ–∫ –ø–ª–∞—Ç–µ–∂—ñ–≤</h3>
        <div class="tableWrap">
          <table id="paymentTable">
            <thead>
              <tr>
                <th>–ú—ñ—Å—è—Ü—å</th>
                <th>–í—ñ–¥—Å–æ—Ç–∫–∏</th>
                <th>–ü–ª–∞—Ç—ñ–∂</th>
                <th>–ó–∞–ª–∏—à–æ–∫</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button type="button" onclick="saveCalculation()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <button type="button" class="light" onclick="exportPDF()">üìÑ PDF</button>
          <button type="button" class="light" onclick="exportExcel()">üìä Excel</button>
          <button type="button" class="light" onclick="window.print()">üñ®Ô∏è –î—Ä—É–∫</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          –£–≤–∞–≥–∞: —Ü–µ —Å–ø—Ä–æ—â–µ–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ (–±–µ–∑ –∫–æ–º—ñ—Å—ñ–π/—à—Ç—Ä–∞—Ñ—ñ–≤/—Å—Ç—Ä–∞—Ö–æ–≤–æ–∫).
        </div>
      </div>

      <div id="savedBox" class="savedBox">
        <div class="savedHeader">
          <h3>–ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="light" type="button" onclick="exportSavedCSV()">‚¨áÔ∏è CSV</button>
            <button class="danger" type="button" onclick="clearSaved()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="savedList" class="savedList"></div>
        <div class="hint">–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–∏—à–µ –Ω–∞ —Ü—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó (localStorage).</div>
      </div>
    </div>
  </main>

  <!-- Libraries for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ---------- helpers ----------
    function fmt(n){
      return (Math.round(n * 100) / 100).toFixed(2);
    }

    function nowStr(){
      return new Date().toLocaleString();
    }

    function getMonthlyRate(){
      const percent = Number(document.getElementById('percent').value);
      const rateType = document.getElementById('rateType').value; // month|year
      if (!percent) return 0;

      if (rateType === 'year') return (percent / 100) / 12;
      return (percent / 100);
    }

    function addRow(month, interest, payment, balance) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${month}</td>
        <td>${fmt(interest)}</td>
        <td>${fmt(payment)}</td>
        <td>${fmt(balance)}</td>
      `;
      document.querySelector('#paymentTable tbody').appendChild(row);
    }

    // ---------- chart ----------
    function drawChart(data){
      const canvas = document.getElementById('chart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');

      // ensure correct width after display
      const w = canvas.width = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
      const h = canvas.height;

      ctx.clearRect(0,0,w,h);

      if (!data || data.length < 2) return;

      const max = Math.max(...data);
      const stepX = w / (data.length - 1);

      // background grid
      ctx.globalAlpha = 0.35;
      ctx.lineWidth = 1;
      ctx.strokeStyle = '#cbd5e1';
      for (let i = 0; i <= 4; i++){
        const y = (h/4)*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(w,y);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // line
      ctx.beginPath();
      ctx.moveTo(0, h - (data[0] / max) * h);

      data.forEach((v,i)=>{
        const x = i * stepX;
        const y = h - (v / max) * h;
        ctx.lineTo(x,y);
      });

      ctx.strokeStyle = '#1f5bff';
      ctx.lineWidth = 3;
      ctx.stroke();

      // points
      ctx.fillStyle = '#1f5bff';
      data.forEach((v,i)=>{
        const x = i * stepX;
        const y = h - (v / max) * h;
        ctx.beginPath();
        ctx.arc(x,y,3.5,0,Math.PI*2);
        ctx.fill();
      });
    }

    // ---------- main calc ----------
    function calculate(){
      const sum = Number(document.getElementById('sum').value);
      const months = Number(document.getElementById('months').value);
      const loanType = document.getElementById('loanType').value; // annuity|diff
      const r = getMonthlyRate();

      if (!sum || !months){
        alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
        return;
      }
      if (months <= 0 || sum <= 0){
        alert('–°—É–º–∞ —ñ —Ç–µ—Ä–º—ñ–Ω –º–∞—é—Ç—å –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0');
        return;
      }

      const resultBox = document.getElementById('result');
      const tbody = document.querySelector('#paymentTable tbody');

      // clear table
      tbody.innerHTML = '';

      let balance = sum;
      let totalPaid = 0;
      let totalInterest = 0;
      let chartData = [sum];

      // annuity: equal monthly payment
      if (loanType === 'annuity'){
        let monthlyPay;

        if (r === 0){
          monthlyPay = sum / months;
        } else {
          monthlyPay = sum * r / (1 - Math.pow(1 + r, -months));
        }

        for (let i = 1; i <= months; i++){
          const interest = balance * r;
          let principal = monthlyPay - interest;

          // last payment adjust (avoid negative pennies)
          if (principal > balance) principal = balance;

          const payment = principal + interest;

          balance -= principal;
          if (balance < 0.01) balance = 0;

          totalPaid += payment;
          totalInterest += interest;

          chartData.push(balance);
          addRow(i, interest, payment, balance);
        }

        document.getElementById('monthly').innerText = fmt(monthlyPay);
      } else {
        // diff: equal principal, decreasing payment
        const principalPart = sum / months;

        // show first month payment as "monthly"
        document.getElementById('monthly').innerText = fmt(principalPart + balance * r);

        for (let i = 1; i <= months; i++){
          const interest = balance * r;
          let principal = principalPart;
          if (principal > balance) principal = balance;

          const payment = principal + interest;

          balance -= principal;
          if (balance < 0.01) balance = 0;

          totalPaid += payment;
          totalInterest += interest;

          chartData.push(balance);
          addRow(i, interest, payment, balance);
        }
      }

      const overpay = totalPaid - sum;

      document.getElementById('total').innerText = fmt(totalPaid);
      document.getElementById('overpay').innerText = fmt(overpay);

      // badges
      const badgeTotal = document.getElementById('badgeTotal');
      const badgeOver = document.getElementById('badgeOver');

      badgeTotal.className = 'badge';
      badgeOver.className = 'badge';

      if (overpay > sum){
        badgeOver.classList.add('danger');
        badgeOver.textContent = '‚ö†Ô∏è –ø–µ—Ä–µ–ø–ª–∞—Ç–∞ > —Å—É–º–∏';
      } else {
        badgeOver.classList.add('ok');
        badgeOver.textContent = 'OK';
      }

      if (r >= 0.30){
        badgeTotal.classList.add('danger');
        badgeTotal.textContent = '‚ö†Ô∏è –¥—É–∂–µ –≤–∏—Å–æ–∫–∏–π %';
      } else if (r === 0){
        badgeTotal.classList.add('ok');
        badgeTotal.textContent = '0%';
      } else {
        badgeTotal.classList.add('ok');
        badgeTotal.textContent = '–Ω–æ—Ä–º–∞';
      }

      // show result
      resultBox.style.display = 'block';
      resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // draw chart after layout
      setTimeout(() => drawChart(chartData), 50);

      // store last calculation to enable quick save/export
      window.__lastCalc = buildCalcObject(totalPaid, overpay, totalInterest);
    }

    function buildCalcObject(totalPaid, overpay, totalInterest){
      return {
        id: cryptoId(),
        date: nowStr(),
        sum: Number(document.getElementById('sum').value),
        percent: Number(document.getElementById('percent').value),
        rateType: document.getElementById('rateType').value,
        months: Number(document.getElementById('months').value),
        loanType: document.getElementById('loanType').value,
        total: Number(totalPaid),
        overpay: Number(overpay),
        interest: Number(totalInterest)
      };
    }

    function cryptoId(){
      // simple unique id without external libs
      return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
    }

    function fillDemo(){
      document.getElementById('sum').value = 5555;
      document.getElementById('percent').value = 55;
      document.getElementById('rateType').value = 'month';
      document.getElementById('months').value = 6;
      document.getElementById('loanType').value = 'annuity';
      calculate();
    }

    // ---------- Save / History ----------
    function getSaved(){
      return JSON.parse(localStorage.getItem('calculations') || '[]');
    }
    function setSaved(arr){
      localStorage.setItem('calculations', JSON.stringify(arr));
    }

    function saveCalculation(){
      // require a successful calculation
      if (!window.__lastCalc){
        alert('–°–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±—ñ—Ç—å —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫');
        return;
      }
      const saved = getSaved();
      saved.unshift(window.__lastCalc);
      setSaved(saved);
      renderSaved();
      alert('–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ ‚úî');
    }

    function toggleSaved(){
      const box = document.getElementById('savedBox');
      const isOpen = box.style.display === 'block';
      box.style.display = isOpen ? 'none' : 'block';
      if (!isOpen) renderSaved();
      if (!isOpen) box.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderSaved(){
      const list = document.getElementById('savedList');
      const saved = getSaved();
      list.innerHTML = '';

      if (!saved.length){
        list.innerHTML = '<div class="hint">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤.</div>';
        return;
      }

      saved.slice(0, 30).forEach(item => {
        const div = document.createElement('div');
        div.className = 'savedItem';

        const typeLabel = item.loanType === 'annuity' ? '–ê–Ω–Ω—É—ó—Ç–µ—Ç' : '–î–∏—Ñ–µ—Ä–µ–Ω—Ü.';
        const rateLabel = item.rateType === 'year' ? '%/—Ä—ñ–∫' : '%/–º—ñ—Å';

        div.innerHTML = `
          <div class="top">
            <div>${item.date} <span class="badge">${typeLabel}</span></div>
            <div><b>–ü–µ—Ä–µ–ø–ª–∞—Ç–∞:</b> ${fmt(item.overpay)} –≥—Ä–Ω</div>
          </div>
          <div class="meta">
            –°—É–º–∞: <b>${fmt(item.sum)}</b> –≥—Ä–Ω ¬∑ %: <b>${item.percent}</b> (${rateLabel}) ¬∑ –ú—ñ—Å—è—Ü—ñ–≤: <b>${item.months}</b><br/>
            –í—Å—å–æ–≥–æ: <b>${fmt(item.total)}</b> –≥—Ä–Ω
          </div>
          <div class="btns">
            <button class="light" type="button" onclick="loadSaved('${item.id}')">‚Ü©Ô∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
            <button class="danger" type="button" onclick="deleteSaved('${item.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function loadSaved(id){
      const saved = getSaved();
      const item = saved.find(x => x.id === id);
      if (!item) return;

      document.getElementById('sum').value = item.sum;
      document.getElementById('percent').value = item.percent;
      document.getElementById('rateType').value = item.rateType;
      document.getElementById('months').value = item.months;
      document.getElementById('loanType').value = item.loanType;

      calculate();
    }

    function deleteSaved(id){
      const saved = getSaved().filter(x => x.id !== id);
      setSaved(saved);
      renderSaved();
    }

    function clearSaved(){
      if (!confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏?')) return;
      localStorage.removeItem('calculations');
      renderSaved();
    }

    function exportSavedCSV(){
      const saved = getSaved();
      if (!saved.length){
        alert('–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤');
        return;
      }

      const headers = ['date','sum','percent','rateType','months','loanType','total','overpay','interest'];
      const rows = [headers.join(',')];

      saved.forEach(s=>{
        const row = headers.map(h => {
          const v = s[h];
          // escape commas/quotes
          const str = String(v ?? '').replace(/"/g,'""');
          return `"${str}"`;
        }).join(',');
        rows.push(row);
      });

      const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'saved-calculations.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Export current result ----------
    function exportPDF(){
      const element = document.getElementById('result');
      if (!element || element.style.display === 'none'){
        alert('–°–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±—ñ—Ç—å —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫');
        return;
      }
      const opt = {
        margin: 10,
        filename: 'kredit-rozrahunok.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }

    function exportExcel(){
      const table = document.getElementById('paymentTable');
      if (!table) return;

      // workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, '–ì—Ä–∞—Ñ—ñ–∫');

      // add summary sheet
      const summary = [
        ['–î–∞—Ç–∞', nowStr()],
        ['–°—É–º–∞', document.getElementById('sum').value],
        ['–í—ñ–¥—Å–æ—Ç–æ–∫', document.getElementById('percent').value],
        ['–ü–µ—Ä—ñ–æ–¥', document.getElementById('rateType').value],
        ['–ú—ñ—Å—è—Ü—ñ–≤', document.getElementById('months').value],
        ['–¢–∏–ø', document.getElementById('loanType').value],
        ['–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞', document.getElementById('total').innerText],
        ['–ü–µ—Ä–µ–ø–ª–∞—Ç–∞', document.getElementById('overpay').innerText],
        ['–©–æ–º—ñ—Å—è—á–Ω–∏–π', document.getElementById('monthly').innerText]
      ];
      const ws2 = XLSX.utils.aoa_to_sheet(summary);
      XLSX.utils.book_append_sheet(wb, ws2, '–ü—ñ–¥—Å—É–º–æ–∫');

      XLSX.writeFile(wb, 'kredit-rozrahunok.xlsx');
    }
  </script>
</body>
</html>

