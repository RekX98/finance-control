<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Фінансовий контроль</title>

<style>
:root{
  --blue:#1f5bff;
  --bg:#f4f6fb;
  --card:#fff;
  --text:#0f172a;
  --muted:#64748b;
  --line:#e5e7eb;
  --danger:#dc2626;
  --ok:#16a34a;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{background:var(--blue);color:#fff;padding:24px;text-align:center}
main{max-width:950px;margin:auto;padding:16px}
.box{background:var(--card);border-radius:16px;padding:18px;margin:14px 0}
label{display:block;margin-top:10px;font-weight:800}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:720px){.row{grid-template-columns:1fr}}
button{padding:12px 16px;border:none;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
button.light{background:#eaf2ff;color:#000}
button.danger{background:var(--danger)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.result-box{display:none;margin-top:14px;background:#eaf2ff;border-left:6px solid var(--blue);padding:14px;border-radius:14px}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
.badge.ok{color:var(--ok)}
.badge.danger{color:var(--danger)}
.tableWrap{margin-top:14px;overflow:auto;background:#fff;border-radius:12px}
table{width:100%;border-collapse:collapse;min-width:560px}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:center}
.chartWrap{background:#fff;padding:10px;border-radius:12px}
#chart{width:100%;height:220px}
.savedBox{display:none;background:#fff;padding:14px;border-radius:14px;margin-top:14px}
.savedItem{border:1px solid var(--line);padding:12px;border-radius:12px;margin-bottom:10px}
.hint{font-size:13px;color:var(--muted)}
</style>
</head>

<body>

<header>
<h1>Фінансовий контроль</h1>
<p>Кредитний калькулятор</p>
</header>

<main>

<div class="box">
<label>Сума</label>
<input id="sum" type="number">

<div class="row">
<div>
<label>%</label>
<input id="percent" type="number">
</div>
<div>
<label>Період</label>
<select id="rateType">
<option value="month">%/міс</option>
<option value="year">%/рік</option>
</select>
</div>
</div>

<div class="row">
<div>
<label>Місяців</label>
<input id="months" type="number">
</div>
<div>
<label>Тип</label>
<select id="loanType">
<option value="annuity">Аннуїтет</option>
<option value="diff">Диференц.</option>
</select>
</div>
</div>

<div class="actions">
<button onclick="calculate()">Порахувати</button>
<button class="light" onclick="toggleSaved()">Історія</button>
</div>

<div id="result" class="result-box">
<div id="rateWarning" class="hint"></div>

<p>Всього: <b id="total"></b></p>
<p>Переплата: <b id="overpay"></b></p>
<p>Місячний: <b id="monthly"></b></p>

<div class="chartWrap">
<canvas id="chart"></canvas>
</div>

<div class="tableWrap">
<table id="paymentTable">
<thead>
<tr><th>Міс</th><th>%</th><th>Платіж</th><th>Залишок</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="actions">
<button onclick="saveCalculation()">Зберегти</button>
<button class="light" onclick="exportPDF()">PDF</button>
<button class="light" onclick="exportExcel()">Excel</button>
</div>
</div>

<div id="savedBox" class="savedBox">
<button class="danger" onclick="clearSaved()">Очистити</button>
<div id="savedList"></div>
</div>

</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
function fmt(n){return Number(n).toFixed(2)}
function rate(){let p=+percent.value;return rateType.value==='year'?p/100/12:p/100}

function calculate(){
let s=+sum.value,m=+months.value,r=rate()
if(!s||!m)return alert('Заповніть поля')

let ann=[],diff=[],bal=s,tbody=paymentTable.querySelector('tbody')
tbody.innerHTML=''
let total=0

// аннуитет
let mp=r? s*r/(1-Math.pow(1+r,-m)) : s/m
for(let i=1;i<=m;i++){
let int=bal*r,pr=mp-int
bal-=pr;if(bal<0)bal=0
ann.push(bal)
tbody.innerHTML+=`<tr><td>${i}</td><td>${fmt(int)}</td><td>${fmt(mp)}</td><td>${fmt(bal)}</td></tr>`
total+=mp
}

// дифф
bal=s
let part=s/m
for(let i=1;i<=m;i++){
let int=bal*r
bal-=part;if(bal<0)bal=0
diff.push(bal)
}

drawChart(ann,diff)

total.innerText=fmt(total)
overpay.innerText=fmt(total-s)
monthly.innerText=fmt(mp)

rateWarning.innerText=
r>=0.3?'⚠️ Кабальний %':
r>=0.05?'❗ Високий %':'✅ Норма'

result.style.display='block'
window.lastCalc={s,m,r,total}
}

function drawChart(a,b){
let c=chart,ctx=c.getContext('2d')
c.width=c.offsetWidth;ctx.clearRect(0,0,c.width,c.height)
let max=Math.max(...a,...b)
let step=c.width/(a.length-1)
function line(d,col){
ctx.beginPath()
d.forEach((v,i)=>{
let x=i*step,y=c.height-v/max*c.height
i?ctx.lineTo(x,y):ctx.moveTo(x,y)
})
ctx.strokeStyle=col;ctx.lineWidth=3;ctx.stroke()
}
line(a,'#1f5bff');line(b,'#16a34a')
}

function saveCalculation(){
let arr=JSON.parse(localStorage.getItem('calculations')||'[]')
arr.push(window.lastCalc)
localStorage.setItem('calculations',JSON.stringify(arr))
renderSaved()
}

function renderSaved(){
let arr=JSON.parse(localStorage.getItem('calculations')||'[]')
savedList.innerHTML=arr.map(x=>`<div class="savedItem">Сума ${x.s}</div>`).join('')
}

function clearSaved(){
localStorage.removeItem('calculations')
renderSaved()
}

function toggleSaved(){
savedBox.style.display=savedBox.style.display?'':'block'
renderSaved()
}

function exportPDF(){html2pdf().from(result).save()}
function exportExcel(){XLSX.writeFile(XLSX.utils.book_new(),'calc.xlsx')}
</script>

</body>
</html>


